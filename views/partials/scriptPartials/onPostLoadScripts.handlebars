<script type="text/javascript">

//this is used to keep track of the oldest post currently loaded in the feed; when the infinite scroll script fetches the next page of posts,
//it should start with posts just older than that. it starts out with the current time as a placeholder (obvs we only want posts older than the current time, we only have posts older than the current time)
needPostsOlderThan = new Date().getTime();

// Globally defining the check height function (should this go somewhere ... else?)
function heightCheckReadMore(e) {
    if (e.height() > 700) {
        var contentCont = e.find('.content');
        if (!contentCont.hasClass('content-warning-post')) {
            var content = contentCont.children();
            content.remove();
            contentCont.append('<div class="abbreviated-content"></div><button type="button" class="button grey-button show-more" data-state="contracted">Show more</button>');
            contentCont.children('.abbreviated-content').append(content);
        }
    }
}
$(function(){
{{#if loggedIn}}

    // TRIBUTE-RELATED FUNCTIONALITY (@-MENTIONS)
    // Init tribute
    $.post('/api/user/followers', function (data) {
        followers = JSON.parse(data).followers;
        tribute = new Tribute({
            values: followers,
            menuItemTemplate: function (item) {
                return '<img class="tribute-image" src="/images/' + item.original.image + '"><span class="tribute-text">' + item.string + '</span>';
            },
            searchOpts: {
                pre: '<strong>',
                post: '</strong>'
            }
        })
        tribute.attach($(".ql-editor")); //attach to new post form and comment fields if there are any that aren't handled when their posts are appended (look a few lines down for that)
    });

{{/if}}

    // Attach scripts to newly loaded posts
    $('#postsContainer').on('append.infiniteScroll', function (event, response, path, items) {
        var newlyLoadedStuff = $(items);

        if(this.fadedOut){
            $(this).fadeIn(250);
        }

        newlyLoadedStuff.each(function(i,e){
            e = $(e);
            var imgs = e.find('img');
            if(imgs.length){
                var loaded = 0;
                imgs.on('load', function(){
                    loaded++;
                    if(loaded == imgs.length){
                        heightCheckReadMore(e);
                    }
                })
                imgs.on('error', function(){
                    loaded++;
                    if(loaded == imgs.length){
                        heightCheckReadMore(e);
                    }
                })
            }else{
                heightCheckReadMore(e);
            }
        })

        needPostsOlderThan = newlyLoadedStuff.last().find("#oldesttimestamp").html(); //the new oldest-post-loaded timestamp is provided by the server in this element

        if(newlyLoadedStuff.find('img.link-preview-image').length > 0){
            newlyLoadedStuff.find('img.link-preview-image').on('error',function(){
                $(this).replaceWith('<div class="link-preview-image" style="font-size:50px;text-align:center;"><i class="fas fa-link"></i></div>');
            })
        }

        if (newlyLoadedStuff.find('.post-images').length > 0) {
            var imagesLoaded = newlyLoadedStuff.find('.post-single-image').length;
            console.log("images loaded: " + imagesLoaded);
            var imagesLightboxed = 0;

            var $images = newlyLoadedStuff.find('.post-images a');
            var $imagesGrouped = $images.filter('[data-group]');
            var $imagesAlone = $images.not($imagesGrouped);

            // Handle standalone images
            $imagesAlone.each(function (index, element) {
                $(element).simpleLightbox();
                imagesLightboxed++;
            });

            // Handle grouped images
            if ($imagesGrouped.length > 0) {
                // Select all groups
                var groupNames = $imagesGrouped.map(function () {
                    return $(this).data('group');
                }).get();
                groupNames = $.unique(groupNames);

                // Apply on each group
                $.each(groupNames, function (key, value) {
                    var filteredGroup = $imagesGrouped.filter(function () { //could this be .find instead of .filter so that it just finds the one instance and stops
                        return $(this).data('group') == value;
                    })
                    filteredGroup.simpleLightbox();
                    imagesLightboxed += filteredGroup.length;
                });
                console.log("images lightboxed: " + imagesLightboxed)
                if (imagesLightboxed != imagesLoaded) {
                    console.log("not all images lightboxed!!!!!!");
                }
                //$.post("/admin/clientsideerrors",{errortext: "not all images lightboxed: "+imagesLoaded+" loaded, "+imagesLightboxed+" lightboxed"})
            }
        }
        {{#if loggedIn}}
        var commentForms = newlyLoadedStuff.find('.editable-text');
        commentForms.each(function(){
            attachQuill(this,'Reply to this post with a good reply');
        })
        if (typeof tribute !== 'undefined') { // Silently fails to load tribute if API has not yet responded, it will be attached to these comment fields when tribute does load (look up a few lines)
            tribute.attach(newlyLoadedStuff.find(".ql-editor"));
        }
        {{/if}}
    });
});
</script>

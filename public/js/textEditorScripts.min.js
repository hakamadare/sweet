function updateSubmitButtonState(e){var t=e.find(".create-comment, #postSubmit");if(0==e.find(".still-loading").length){t=e.find(".create-comment, #postSubmit");t.attr("disabled",!1),t.hasClass("save-draft-button")?t.html('Save <i class="fas fa-chevron-right"></i>'):t.hasClass("create-comment")?t.html('Reply <i class="fas fa-chevron-right"></i>'):"postSubmit"==t.attr("id")&&t.html('Send <i class="fas fa-chevron-right"></i>')}else t.attr("disabled",!0),t.html("<i class='fas fa-spinner fa-spin'></i> Uploading")}function clearEmbed(e){var t=$(this).closest(".slidable-embed");!t.hasClass("image-preview-container")||t.attr("imagealreadysaved")||t.hasClass("still-loading")||$.post("/cleartempimage",{imageURL:t.attr("image-url")});var i=t.closest(".ql-container")[0].__quill;i.updateContents(),i.focus(),t[0].request&&4!=t[0].request.readyState&&t[0].request.abort();var r=t.closest(".new-comment-form, .contentForm");t.remove(),updateSubmitButtonState(r),createImageGroups(r.find(".ql-editor"))}function attachQuill(e,t,i){var r=new Quill(e,{formats:["bold","italic","list","link","blockquote","PostImage","LinkPreview"],modules:{toolbar:["bold","italic",{list:"bullet"},"link","blockquote"],keyboard:{bindings:{"list autofill":{key:32,handler:function(){return!0}},blqtBksp:{key:"backspace",collapsed:!0,format:["blockquote"],offset:0,handler:function(e,t){this.quill.format("blockquote",!1)}},embedBksp:{key:"backspace",collapsed:!0,offset:0,handler:function(e,t){if("\n"==this.quill.getText(e.index,1)){var i=this.quill.getContents(e.index-1,1);if(i.ops.length&&i.ops[0].insert&&(i.ops[0].insert.LinkPreview||i.ops[0].insert.PostImage))return this.quill.deleteText(e.index,1),!1}return!0}}}}},placeholder:t||"Write something, highlight text to format.",theme:"bubble"});r.clipboard.addMatcher(Node.ELEMENT_NODE,function(e,t){for(var i=0;i<t.ops.length;i++)"string"!=typeof t.ops[i].insert&&(t.ops[i].insert="");return t}),r.clipboard.addMatcher("ol",function(e,t){for(var i=0;i<t.ops.length;i++)t.ops[i].attributes&&t.ops[i].attributes.list&&"ordered"==t.ops[i].attributes.list&&delete t.ops[0].attributes.list;return t}),r.on("selection-change",function(t,i,r){t||(e.lastCursorPos=i.index)}),e.insertEmojiAtCursor=function(t){var i=void 0;(i=r.getSelection())?(i.length>0&&r.deleteText(i.index,i.length),r.insertText(i.index,t)):e.lastCursorPos?r.insertText(e.lastCursorPos,t):(r.insertText(0,t),r.focus(),r.setSelection(t.length,0))},e.hasContent=function(){return r.getText().trim().length>0||r.getLength()>r.getText().length},e.getContents=function(){if(e.imagesAdded()>0||e.linkPreviewsAdded()>0){var t=$(e).children(".ql-editor").children(),i=[];return t.each(function(e,t){t=$(t);if(!(t.hasClass("still-loading")||t.hasClass("onthemove")||t.hasClass("embedspacer")||"loading..."==t.attr("image-url")))if(t.hasClass("link-preview-container"))i.push({type:"link-preview",linkUrl:t.attr("linkUrl")});else if(t.hasClass("image-preview-container")){var r=i[i.length-1];r&&"string"!=typeof r&&"image(s)"==r.type?(r.imageDescriptions.push(t.find("#postImageDescription").val()),r.images.push(t.attr("image-url"))):i.push({type:"image(s)",imageDescriptions:[t.find("#postImageDescription").val()],images:[t.attr("image-url")]})}else i.push(t[0].outerHTML)}),i}return $(e).children(".ql-editor").html()},e.getQuill=function(){return r},i||(r.on("text-change",function(e,t,i){""===r.getText()&&r.insertText(r.getLength(),"\n")}),e.addLinkPreview=function(t){var i=r.getSelection(!0),a=i.index;if(0==i.length&&"\n"==r.getText(a,1)&&""!=r.getText(a+1,1)){r.deleteText(a,1);var o=a}else o=r.getLength();r.insertEmbed(o,"LinkPreview",t,Quill.sources.USER),updateSubmitButtonState($(e).closest(".contentForm, .new-comment-form"))},e.addImage=function(t){var i=r.getSelection(!0),a=i?i.index:0;if(0==i.length&&"\n"==r.getText(a,1)&&""!=r.getText(a+1,1)){r.deleteText(a,1);var o=a}else o=r.getLength();try{r.insertEmbed(o,"PostImage",t,Quill.sources.USER)}catch(e){console.log("image type/size unsupported!"),console.log(e)}updateSubmitButtonState($(e).closest(".contentForm, .new-comment-form")),createImageGroups($(e).children(".ql-editor"))},e.imagesAdded=function(){return $(e).children(".ql-editor").children(".image-preview-container").length},e.linkPreviewsAdded=function(){return $(e).children(".ql-editor").children(".link-preview-container").length},e.onclick=function(e){var t=$(e.target);if(t.hasClass("ql-editor")){var i=t.children(),a=i.first(),o=i.last();if(a.hasClass("slidable-embed")&&e.clientY<getTop(a))r.insertText(0,"\n"),r.setSelection(0);else if(o.hasClass("slidable-embed")&&e.clientY>getTop(o)+o.outerHeight(!1))r.insertText(r.getLength(),"\n"),r.setSelection(r.getLength());else{var n=void 0,s=!1;t.children().each(function(i,r){if(!s){if(r=$(r),n&&r.hasClass("slidable-embed")&&n.hasClass("slidable-embed")&&e.clientY<getTop(r)&&e.clientY>getTop(n)+n.outerHeight(!1)){var a=$("<p></p>");n.after(a);var o=window.getSelection(),l=document.createRange();l.setStart(a[0],0),l.collapse(!0),o.removeAllRanges(),o.addRange(l),s=!0,createImageGroups(t)}n=r}})}}},e.onpaste=function(t){for(var i=(event.clipboardData||event.originalEvent.clipboardData).items,r=0;r<i.length;r++)if(0===i[r].type.indexOf("image")){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}t.preventDefault(),e.addImage(i[r].getAsFile())}},e.ondrop=function(t){if(t.preventDefault(),$(".post-controls").css("display","flex"),t.dataTransfer.items)for(var i=0;i<t.dataTransfer.items.length;i++){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}"file"===t.dataTransfer.items[i].kind&&0===t.dataTransfer.items[i].type.indexOf("image")&&e.addImage(t.dataTransfer.items[i].getAsFile())}else for(i=0;i<t.dataTransfer.files.length;i++){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}0===t.dataTransfer.files[i].type.indexOf("image")&&e.addImage(t.dataTransfer.files[i])}removeBodyFader(t)},dragFaderActivated||($(function(){document.body.ondragover=function(e){e.preventDefault();var t=e.dataTransfer;t.types&&(t.types.indexOf?-1!=t.types.indexOf("Files"):t.types.contains("Files"))&&(faded||($("body").append('<div id="bodyFader"></div>'),$("#bodyFader").fadeIn(100),faded=!0))},document.body.ondragend=removeBodyFader,document.body.ondrop=removeBodyFader,window.ondragenter=function(e){e.preventDefault(),dragcounter++},window.ondragleave=function(e){dragcounter--,dragcounter<1&&removeBodyFader(e)}}),dragFaderActivated=!0))}function removeBodyFader(e){e.preventDefault(),$("#bodyFader").fadeOut(100,function(){$("#bodyFader").remove(),dragcounter=0,faded=!1})}function mousedownOnHandle(e){e.preventDefault(),$(this).addClass("in-use");var t=$(this).parent().parent(),i=prepareEmbedForMoving(t);i[0].pointerOffset=e.originalEvent.clientY-getTop(i),prevPointerY=e.originalEvent.clientY,$(document).mousemove(function(e){return e.preventDefault(),moveEmbed(e.originalEvent.clientY,i,t),!1}),$(document).on("mouseup",function(e){endMovement(),$(document).off("mousemove"),$(document).off("mouseup")})}function touchStartOnHandle(e){function t(e){e.cancelable&&e.preventDefault(),moveEmbed(e.changedTouches[0].clientY,r,i)}if(e.cancelable&&e.preventDefault(),!touchinprogress){touchinprogress=!0;var i=$(this).parent().parent(),r=prepareEmbedForMoving(i);r[0].pointerOffset=e.changedTouches[0].clientY-getTop(r),prevPointerY=e.changedTouches[0].clientY,this.addEventListener("touchmove",t,{passive:!1}),this.addEventListener("touchend",function(e){touchinprogress=!1,this.removeEventListener("touchmove",t),endMovement()}),this.addEventListener("touchcancel",function(e){touchinprogress=!1,this.removeEventListener("touchmove",t),endMovement()})}}function getTop(e){return e.offset().top-$(window).scrollTop()}function prepareEmbedForMoving(e){var t=e,i=e.clone(!1);return i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-clear").click(clearEmbed),i.css("width",t.outerWidth(!0)+"px"),i.css("left",t.offset().left+"px"),i.css("top",getTop(t)+"px"),e.hasClass("ipc-group")&&createImageGroups(e.parent()),t.addClass("embedspacer"),t.attr("id",""),t.removeClass("ipc-group ipc-group-top ipc-group-bottom"),$("body").append(i),i.css("position","fixed"),i.css("z-index",2147483647),i.removeClass("ipc-group ipc-group-top ipc-group-bottom"),i.addClass("onthemove"),t.empty(),i[0].scrollPrompterId=setInterval(function(){scrollPrompter(i,t.closest(".ql-editor"))},50),lastWindowPos=window.scrollY,$(window).on("scroll",function(e){window.scrollY>lastWindowPos?moveEmbed(prevPointerY,i,t,"down"):window.scrollY<lastWindowPos&&moveEmbed(prevPointerY,i,t,"up"),lastWindowPos=window.scrollY}),i}function scrollPrompter(e,t){var i=getTop(e),r=e.outerHeight(),a=i+r,o=getTop(t),n=o+t.outerHeight(),s=t.closest(".modal"),l=$(window),d=l.scrollTop(),c=l.height();i<100&&o<50?s.length?s.scrollTop(s.scrollTop()-10):l.scrollTop(d-10):a>c-100&&n>c&&(s.length?s.scrollTop(s.scrollTop()+10):l.scrollTop(d+10))}function moveEmbed(e,t,i,r){var a=e-prevPointerY;prevPointerY=e;var o=getTop(t),n=(getTop(i),t.outerHeight(!0)),s=Math.min(Math.max(e-t[0].pointerOffset,getTop(i.parent())),getTop(i.parent())+(i.parent().outerHeight(!0)-i.outerHeight(!0)));if(t.css("top",s+"px"),"down"==r||a>0){for(var l=i.next();l.length&&l.next().length&&o+n>getTop(l)+l.outerHeight(!0);)l=l.next();if(l.length){var d=getTop(l),c=Math.max(d+.5*l.outerHeight(!0),d+l.outerHeight(!0)-70);o+n>c&&i.insertAfter(l)}}else if("up"==r||a<0){for(var m=i.prev();m.length&&m.prev().length&&o<getTop(m);)m=m.prev();if(m.length){c=Math.min(getTop(m)+.5*m.outerHeight(!0),getTop(m)+70);o<c&&i.insertBefore(m)}}createImageGroups(i.parent())}function endMovement(){var e=$(".onthemove");if(e.length){clearInterval(e[0].scrollPrompterId),$(window).off("scroll"),$(".embedspacer").after($(".onthemove")),e.css("position","").css("border","").css("width","").css("left","").css("top","").css("height","").css("z-index",10),e.removeClass("onthemove"),e.find(".image-move").removeClass("in-use");var t=$(".embedspacer");t.remove(),createImageGroups(e.closest(".ql-editor"))}}function createImageGroups(e){for(var t=e.children(),i=0,r=0;r<t.length;r++){var a=$(t[r]);a.hasClass("image-preview-container")&&!a.hasClass("embedspacer")?(i++,i>1&&(2==i?$(t[r-1]).addClass("ipc-group ipc-group-top").removeClass("ipc-group-bottom"):$(t[r-1]).addClass("ipc-group").removeClass("ipc-group-top ipc-group-bottom"))):(i>1?$(t[r-1]).addClass("ipc-group ipc-group-bottom").removeClass("ipc-group-top"):1==i&&$(t[r-1]).removeClass("ipc-group ipc-group-top ipc-group-bottom"),i=0)}i>1?$(t[t.length-1]).addClass("ipc-group ipc-group-bottom").removeClass("ipc-group-top"):1==i&&$(t[t.length-1]).removeClass("ipc-group ipc-group-top ipc-group-bottom")}var newEmbedId=0;let BlockEmbed=Quill.import("blots/block/embed");class LinkPreview extends BlockEmbed{static create(e){var t=/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/,i=/^(http|https)?:\/\/(www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|)(\d+)(?:|\/\?)$/,r=t.test(e)||i.test(e);let a=super.create();a.setAttribute("id","embed"+newEmbedId),a.setAttribute("linkUrl",e);var o=newEmbedId;newEmbedId++,a.setAttribute("data-url",e),a.setAttribute("contenteditable",!1),a.innerHTML=$("#new-post-link-preview-contents")[0].innerHTML;var n=$(a);return n.addClass("still-loading"),n.addClass("slidable-embed"),n.find(".link-preview-image").on("error",function(e){$(this).replaceWith('<div class="link-preview-image""><i class="fas fa-link"></i></div>')}),a.request=$.post("/api/newpostform/linkpreviewdata",{url:e},function(t,i,a){var n=$("#embed"+o);if(n.length)if(n.removeClass("still-loading"),"invalid url i guess"==t)bootbox.alert("Sorry, we couldn't connnect to that url ("+e+") to obtain a preview :("),endMovement(),n.find(".image-clear").click();else{var s=JSON.parse(t);s.image?n.find(".link-preview-image").replaceWith('<img class="link-preview-image" src="'+s.image+'" />'):n.find(".link-preview-image").replaceWith('<div class="link-preview-image"><i class="fas fa-link"></i></div>'),n.find(".link-preview-title").html(s.title),n.find(".link-preview-description").html(s.description),n.find(".link-preview-domain").html(s.domain+(r?" (will open as embed)":"")),updateSubmitButtonState(n.closest(".new-comment-form, .contentForm"))}}),a.request.fail(function(t,i,r){var a=$("#embed"+o);a.length&&(a.removeClass("still-loading"),bootbox.alert("Sorry, we couldn't connect to that url ("+e+") to obtain a preview :("),endMovement(),a.find(".image-clear").click(),"abort"!=r&&$.post("/admin/reporterror",{errorstring:"error creating link preview for url "+e+":\n"+r}))}),n.find(".image-clear").click(clearEmbed),n.find(".image-move").on("mousedown",mousedownOnHandle),n.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),a}static value(e){return e.getAttribute("data-url")}static formats(e){var t=$(e);return t.hasClass("still-loading")||t.hasClass("onthemove")||t.hasClass("embedspacer")?{}:{title:t.find(".link-preview-title").html(),description:t.find(".link-preview-description").html(),domain:t.find(".link-preview-domain").html().replace(" (will open as embed)",""),image:t.find(".link-preview-image").attr("src")}}}LinkPreview.blotName="LinkPreview",LinkPreview.tagName="a",LinkPreview.className="link-preview-container",Quill.register(LinkPreview);var files={};class PostImage extends BlockEmbed{static create(e){if("string"==typeof e){var t=e;let r=super.create();r.setAttribute("contenteditable",!1),r.setAttribute("imagealreadysaved","true"),r.setAttribute("fullsavedurl",t),r.innerHTML=$("#new-post-image-preview-contents")[0].innerHTML,r.setAttribute("id","embed"+newEmbedId),newEmbedId++;var i=$(r);return i.addClass("slidable-embed"),i.find(".fader").remove(),i.find(".image-preview").css("background-image","url("+t+")"),i.find(".image-clear").click(clearEmbed),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),r}var r=e;if("image/jpeg"!=r.type&&"image/png"!=r.type&&"image/gif"!=r.type)throw bootbox.alert("Sorry, but this appears to be an unsupported file type! We only take JPG, PNG, and GIF images at the moment"),(r.name?r.name:"")+" of unsupported mime type";if(!(("image/jpeg"===r.type||"image/png"===r.type)&&r.size<10485760||"image/gif"===r.type&&r.size<5242880))throw bootbox.alert("Sorry, but this file appears to be too large! The maximum size for GIF images is 5MB and for JPG and PNG images is 10MB."),(r.name?r.name:"")+" too large";let a=super.create();a.setAttribute("id","embed"+newEmbedId),files[a.getAttribute("id")]=r;var o=newEmbedId;newEmbedId++,a.setAttribute("contenteditable",!1),a.setAttribute("image-url","loading..."),a.innerHTML=$("#new-post-image-preview-contents")[0].innerHTML;i=$(a);i.addClass("still-loading"),i.addClass("slidable-embed");var n=URL.createObjectURL(r);i.find(".image-preview")[0].style.backgroundImage="url("+n+")";var s=new FormData;return s.append("image",r),a.request=$.ajax({xhr:function(){var e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t=Math.round(e.loaded/e.total*100),i=$("#embed"+o);i.find("progress").attr("value",t),i.find("#percentage").html(100==t?t+"%!!!":t+"%")}),e},url:"/api/image/v2",type:"POST",data:s,processData:!1,contentType:!1,error:function(e,t,i){var r=$("#embed"+o);r.find("progress").attr("value",0),r.find("#percentage").html("Upload error :( Hit the X and try again?"),console.log("image upload error: "+i),r.removeClass("still-loading"),updateSubmitButtonState(r.closest(".new-comment-form, .contentForm")),"abort"!=i&&$.post("/admin/reporterror",{errorstring:"error uploading image:\n"+i})},success:function(e,t,i){var a=$("#embed"+o);a.removeClass("still-loading");var n=JSON.parse(e);n.error?("filesize"==n.error?bootbox.alert("Image too large! The maximum size for GIF images is 5MB and for JPG and PNG images is 10MB."):"filetype"==n.error&&bootbox.alert("We cannot use this fileOrUrl! Please make sure you are uploading a JPG, PNG, or GIF from this universe."),endMovement(),a.find(".image-clear").click()):(n.thumbnail&&$.get({url:n.thumbnail,success:function(e){a.find(".image-preview").css("background-image","url("+URL.createObjectURL(e)+")")},processData:!1,xhr:function(){var e=new XMLHttpRequest;return e.responseType="blob",e}}),a.find(".fader").remove(),a.attr("image-url",n.url),updateSubmitButtonState(a.closest(".new-comment-form, .contentForm")),setTimeout(function(){var e=$("#embed"+o);if(e.length){$(".bootbox-alert.show").length||bootbox.alert("hey your images are expired and stuff whoops sorry! this tab has apparently been open for a week. or maybe linear time has ceased to function. i guess you can reupload? you probably weren't going to finish this post anyway? geez");var t=e.find("#postImageDescription").val();t.trim()?e.replaceWith("<p>Image: "+t.trim()+(r.name?" ("+r.name+")":"")+"</p>"):r.name?"image.png"!=r.name?e.replaceWith("<p>Image: "+r.name+"</p>"):e.replaceWith("<p>Pasted image</p>"):e.replaceWith("<p>Image</p>"),createImageGroups(e.parent())}},6048e5))}}),i.find(".image-clear").click(clearEmbed),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),a}static value(e){return e.getAttribute("imagealreadysaved")?e.getAttribute("fullsavedurl"):files[e.getAttribute("id")]}static formats(e){return{description:$(e).find("#postImageDescription").val(),imageURL:e.getAttribute("image-url")}}format(e,t){"description"==e?$(this.domNode).find("#postImageDescription").val(t):"imageURL"==e&&this.domNode.setAttribute("image-url",t)}}PostImage.blotName="PostImage",PostImage.tagName="div",PostImage.className="image-preview-container",Quill.register(PostImage);var dragcounter=0,faded=!1;dragFaderActivated=!1;var touchinprogress=!1;window.addEventListener("beforeunload",function(e){$("div.image-preview-container:not(.still-loading)").each(function(e,t){t.getAttribute("imagealreadysaved")||$.post("/cleartempimage",{imageURL:t.getAttribute("image-url")})})});